# ç¬¬ 9 ç« ï¼šä¼šè¯ç®¡ç†ä¸ä¸Šä¸‹æ–‡æ„å»º

**é¢„è®¡å­¦ä¹ æ—¶é—´ï¼š2 å°æ—¶**  
**éš¾åº¦ï¼šâ­â­â­**

---

## ğŸ“š æœ¬ç« ç›®æ ‡

- ç†è§£ `Session` ä¸ `SessionManager` çš„æŒä¹…åŒ–æœºåˆ¶
- æŒæ¡ `get_history()` çš„æˆªæ–­ä¸å¯¹é½ç­–ç•¥
- ç†è§£ `ContextBuilder` å¦‚ä½•æ‹¼è£…ç³»ç»Ÿæç¤ºè¯ä¸ç”¨æˆ·æ¶ˆæ¯
- èƒ½å¤Ÿåˆ†æä¸€æ¬¡ Prompt ç»„è£…ç»“æœ

---

## ğŸ“– ç†è®ºå­¦ä¹ ï¼ˆ30 åˆ†é’Ÿï¼‰

### 1. Session ä¸ºä»€ä¹ˆæ˜¯ append-only

åœ¨ `nanobot/session/manager.py` ä¸­ï¼Œä¼šè¯æ¶ˆæ¯é‡‡ç”¨è¿½åŠ å¼ä¿å­˜ï¼ˆJSONLï¼‰ï¼Œæ ¸å¿ƒæ”¶ç›Šï¼š

- æ›´ç¨³çš„å†å²å¯è¿½æº¯æ€§
- ä¸è®°å¿†å½’æ¡£é€»è¾‘è§£è€¦
- é™ä½ä¿®æ”¹å†å²å¸¦æ¥çš„ä¸Šä¸‹æ–‡ä¸ä¸€è‡´é£é™©

### 2. `get_history()` çš„å…³é”®ç­–ç•¥

`Session.get_history(max_messages=...)` ä¸ç›´æ¥è¿”å›å…¨éƒ¨æ¶ˆæ¯ï¼Œè€Œæ˜¯ï¼š

1. ä» `last_consolidated` ä¹‹åå–â€œæœªå½’æ¡£â€å†å²
2. æˆªæ–­åˆ°çª—å£å¤§å°
3. ä¸¢å¼ƒå¼€å¤´é user ç‰‡æ®µï¼Œé¿å…å­¤ç«‹ `tool` æ¶ˆæ¯

### 3. ContextBuilder çš„èŒè´£è¾¹ç•Œ

`ContextBuilder` ä¸è´Ÿè´£æ¨ç†ï¼Œåªè´Ÿè´£â€œæ‹¼è£…è¾“å…¥â€ï¼š

- ç³»ç»Ÿèº«ä»½ä¸è¿è¡Œæ—¶ä¿¡æ¯
- bootstrap æ–‡ä»¶ï¼ˆAGENTS/SOUL/USER/TOOLS...ï¼‰
- è®°å¿†ä¸Šä¸‹æ–‡ï¼ˆ`MEMORY.md`ï¼‰
- æŠ€èƒ½æ‘˜è¦ä¸è‡ªåŠ¨åŠ è½½æŠ€èƒ½
- å½“å‰ç”¨æˆ·æ¶ˆæ¯ + Runtime Context

---

## ğŸ’» ä»£ç é˜…è¯»ï¼ˆ50 åˆ†é’Ÿï¼‰

### ä»»åŠ¡ 1ï¼šSession æŒä¹…åŒ–ç»“æ„ï¼ˆ20 åˆ†é’Ÿï¼‰

æ‰“å¼€ï¼š`nanobot/session/manager.py`

é‡ç‚¹å…³æ³¨ï¼š

- `Session` æ•°æ®ç»“æ„ï¼ˆ`messages`, `last_consolidated`ï¼‰
- `SessionManager.save()` çš„ JSONL ç»“æ„
- `_load()` å¦‚ä½•å…¼å®¹æ—§ç›®å½•å¹¶è¿ç§»

### ä»»åŠ¡ 2ï¼šPrompt ç»„è£…ï¼ˆ20 åˆ†é’Ÿï¼‰

æ‰“å¼€ï¼š`nanobot/agent/context.py`

é‡ç‚¹å…³æ³¨ï¼š

- `build_system_prompt()`
- `_inject_runtime_context()`
- `build_messages()`
- `_build_user_content()`ï¼ˆå«å›¾åƒè¾“å…¥åœºæ™¯ï¼‰

### ä»»åŠ¡ 3ï¼šä¸²è”åˆ° AgentLoopï¼ˆ10 åˆ†é’Ÿï¼‰

æ‰“å¼€ï¼š`nanobot/agent/loop.py`

è§‚å¯Ÿ `_process_message()` ä¸­ï¼š

```
session.get_history()
  â†’ context.build_messages()
  â†’ provider.chat()
  â†’ _save_turn()
```

---

## ğŸ”§ å®è·µæ“ä½œï¼ˆ40 åˆ†é’Ÿï¼‰

### ç»ƒä¹  1ï¼šè§‚å¯Ÿä¼šè¯æ–‡ä»¶å¢é•¿ï¼ˆ15 åˆ†é’Ÿï¼‰

1. ä½¿ç”¨å›ºå®šä¼šè¯ ID è¿ç»­å¯¹è¯ 5~10 è½®
2. æ‰“å¼€ workspace ä¸‹ `sessions/*.jsonl`
3. éªŒè¯ç¬¬ä¸€è¡Œä¸º metadataï¼Œåç»­ä¸ºæ¶ˆæ¯è¡Œ

### ç»ƒä¹  2ï¼šéªŒè¯ history æˆªæ–­ï¼ˆ15 åˆ†é’Ÿï¼‰

1. å°† `memory_window` è°ƒå°ï¼ˆå¦‚ 10ï¼‰
2. è¿ç»­å¤šè½®å¯¹è¯åè§‚å¯Ÿæ¨¡å‹å¯¹â€œå¾ˆæ—©æ¶ˆæ¯â€çš„è®°å¿†å˜åŒ–
3. å¯¹ç…§ `get_history()` é€»è¾‘è§£é‡Šç°è±¡

### ç»ƒä¹  3ï¼šéªŒè¯ Runtime Context æ³¨å…¥ï¼ˆ10 åˆ†é’Ÿï¼‰

è®© Agent å¤è¿°å½“å‰æ—¶é—´/é¢‘é“ä¿¡æ¯ï¼Œç¡®è®¤æ¥è‡ª `ContextBuilder._inject_runtime_context()`ã€‚

---

## âœ… æœ¬ç« æ£€æŸ¥æ¸…å•

- [ ] æˆ‘èƒ½è§£é‡Š `last_consolidated` çš„ç”¨é€”
- [ ] æˆ‘èƒ½ç”»å‡º `get_history()` çš„ç­›é€‰æµç¨‹
- [ ] æˆ‘èƒ½å®šä½ `build_system_prompt()` çš„è¾“å…¥æ¥æº
- [ ] æˆ‘èƒ½è¯´æ˜ä¸ºä»€ä¹ˆè¦æ³¨å…¥ Runtime Context

---

**å­¦ä¹ è¿›åº¦ï¼š** [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 9/21 ç« èŠ‚  
**ä¸‹ä¸€ç« ï¼š** [ç¬¬ 10 ç« ï¼šè®°å¿†ç³»ç»Ÿä¸å‘é‡æ£€ç´¢](./chapter10.md)
