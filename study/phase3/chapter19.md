# 第 19 章：测试编写与调试技巧

**预计学习时间：2.5 小时**  
**难度：⭐⭐⭐⭐**

---

## 📚 本章目标

- 掌握 pytest 在 nanobot 项目中的基本用法
- 学会为异步逻辑编写测试（`pytest-asyncio`）
- 学会使用 Mock 与 Fixture 降低测试耦合
- 建立可复现、可定位的问题排查流程

---

## 📖 理论学习（35 分钟）

### 1. 测试分层思路

建议按三层推进：

1. 单元测试：验证函数/类局部行为
2. 组件测试：验证模块协作（如 Agent + ToolRegistry）
3. 集成测试：验证端到端关键路径

### 2. 异步测试关键点

对于 `async` 函数测试，需注意：

- 使用 `pytest.mark.asyncio`
- 避免未等待协程导致“假通过”
- 对超时场景设置明确断言

### 3. 调试最小闭环

定位问题时优先构建“最小可复现案例”：

- 最小输入
- 最小配置
- 最小依赖

---

## 💻 代码阅读（45 分钟）

### 任务 1：阅读现有测试组织（15 分钟）

查看：`tests/` 目录下所有测试文件

重点关注：

- 命名规范（`test_*.py`）
- 模块拆分方式
- 场景覆盖边界

### 任务 2：精读异步测试样例（15 分钟）

建议阅读：

- `tests/test_cron_service.py`
- `tests/test_heartbeat_service.py`

重点关注：

- async fixture 的使用
- 定时/事件行为如何断言

### 任务 3：精读工具与命令测试（15 分钟）

建议阅读：

- `tests/test_tool_validation.py`
- `tests/test_commands.py`

重点关注：

- 参数校验测试写法
- CLI 行为测试策略

---

## 🔧 实践操作（40 分钟）

### 练习 1：给自定义 Tool 写测试（15 分钟）

目标：为第 15 章新增工具补充测试。

至少覆盖：

- 正常返回
- 非法参数
- 异常路径（如读取失败）

### 练习 2：给自定义 Channel 写测试（15 分钟）

目标：验证入站映射与出站过滤逻辑。

至少覆盖：

- 正常消息路由
- 非目标 channel 忽略
- 发送失败日志可见

### 练习 3：调试演练（10 分钟）

运行测试后，故意制造一个失败用例并修复，记录：

- 错误现象
- 定位过程
- 修复方案

---

## ✅ 本章检查清单

- [ ] 我能写出 1 个异步测试并稳定通过
- [ ] 我能使用 fixture/mock 降低外部依赖
- [ ] 我完成了至少 3 个新增断言场景
- [ ] 我能清晰描述一次失败排查过程

---

**学习进度：** [███████████████████░░] 19/21 章节  
**下一章：** [第 20 章：性能优化与问题排查](./chapter20.md)
