# 第 20 章：性能优化与问题排查

**预计学习时间：2.5 小时**  
**难度：⭐⭐⭐⭐**

---

## 📚 本章目标

- 建立 nanobot 常见性能问题的排查框架
- 学会识别异步系统中的瓶颈点
- 掌握日志优化与观测指标设计思路
- 形成可复用的故障排查清单

---

## 📖 理论学习（35 分钟）

### 1. 性能问题常见来源

在 Agent 系统中，瓶颈通常来自：

- 外部 API 延迟（LLM / Channel 平台）
- 工具执行阻塞（长命令、慢 I/O）
- 上下文过大导致推理时间增长
- 任务并发过高引发排队

### 2. 三段式排查法

建议按顺序排查：

1. 入口是否堵塞（消息是否及时入队）
2. 中段是否阻塞（Agent 循环/工具执行）
3. 出口是否堆积（Channel 发送）

### 3. 可观测性优先级

优先保证三类信息可观测：

- 延迟（消息处理耗时）
- 吞吐（单位时间处理量）
- 失败率（超时、异常、重试）

---

## 💻 代码阅读（45 分钟）

### 任务 1：阅读 Agent 主循环（15 分钟）

打开：`nanobot/agent/loop.py`

重点关注：

- 迭代次数与工具调用路径
- 超时与异常处理
- 会话归档触发点

### 任务 2：阅读队列与事件（15 分钟）

打开：

- `nanobot/bus/queue.py`
- `nanobot/bus/events.py`

重点关注：

- 消息发布/订阅路径
- 潜在背压点

### 任务 3：阅读心跳与定时服务（15 分钟）

打开：

- `nanobot/heartbeat/service.py`
- `nanobot/cron/service.py`

重点关注：

- 定时触发与并发执行策略
- 资源释放与停止流程

---

## 🔧 实践操作（40 分钟）

### 练习 1：建立“慢请求”基线（15 分钟）

目标：记录一次完整请求在各阶段耗时。

建议记录：

- 收到入站时间
- 调用 Provider 开始/结束
- 工具执行开始/结束
- 发出出站时间

### 练习 2：日志优化（15 分钟）

目标：将关键日志从“能看懂”优化到“可检索、可对比”。

要求：

- 日志携带 session/channel
- 关键阶段带耗时
- 异常日志包含可复现信息

### 练习 3：故障演练（10 分钟）

模拟并处理以下任一故障：

- Provider 超时
- 工具执行超时
- Channel 回包失败

---

## ✅ 本章检查清单

- [ ] 我能使用三段式方法定位慢点
- [ ] 我能给出至少 2 条可执行优化建议
- [ ] 我完成了一次日志优化并验证有效
- [ ] 我完成了至少 1 个故障场景排查

---

**学习进度：** [████████████████████░] 20/21 章节  
**下一章：** [第 21 章：贡献代码与最佳实践](./chapter21.md)
