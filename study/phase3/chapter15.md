# 第 15 章：创建自定义 Tool

**预计学习时间：2 小时**  
**难度：⭐⭐⭐**

---

## 📚 本章目标

- 理解自定义 Tool 的最小实现要素
- 掌握 JSON Schema 参数定义与输入校验
- 学会将新工具注册到 `ToolRegistry`
- 能够为工具补充基础测试

---

## 📖 理论学习（35 分钟）

### 1. Tool 的统一契约

在 nanobot 中，所有工具都遵循统一接口：

- `name`：工具唯一标识
- `description`：给模型看的工具说明
- `parameters`：JSON Schema 参数结构
- `execute(**kwargs)`：异步执行入口

核心代码位置：

- `nanobot/agent/tools/base.py`
- `nanobot/agent/tools/registry.py`

### 2. 参数设计原则

一个可用的工具参数 schema 应满足：

- 参数名语义明确（如 `target_path` 比 `p` 更好）
- 必选项尽量少，可选项给合理默认值
- 对可能误用的参数做约束（范围、枚举、格式）
- 错误信息可直接指导修复

### 3. 工具执行的可观测性

建议在 `execute()` 内提供：

- 输入合法性检查
- 关键步骤日志
- 稳定、可解析的返回文本（便于模型继续推理）

---

## 💻 代码阅读（45 分钟）

### 任务 1：阅读 Tool 基类（15 分钟）

打开：`nanobot/agent/tools/base.py`

重点关注：

- 抽象属性和方法如何定义
- 工具实例生命周期
- 通用异常处理方式

### 任务 2：阅读注册与调用链（15 分钟）

打开：

- `nanobot/agent/tools/registry.py`
- `nanobot/agent/loop.py`（工具注册与调用相关段落）

重点关注：

- 工具如何被注册到 registry
- LLM 返回 tool call 后如何转发到工具执行

### 任务 3：参考内置工具实现（15 分钟）

打开：`nanobot/agent/tools/filesystem.py`

重点关注：

- `parameters` 的写法
- 返回结果文本风格
- 错误场景的处理方式

---

## 🔧 实践操作（40 分钟）

### 练习 1：实现“系统监控工具”（20 分钟）

目标：新增一个自定义工具，输出基本系统信息（CPU、内存、磁盘）

建议步骤：

1. 新建工具类文件（可放在 `nanobot/agent/tools/`）
2. 定义 `name/description/parameters`
3. 在 `execute()` 中返回结构化文本
4. 在默认工具注册流程中添加该工具

### 练习 2：增加错误处理（10 分钟）

要求：

- 无权限或命令缺失时，返回清晰错误
- 超时或读取失败时，不让整个 Agent 崩溃

### 练习 3：手动验证工具调用（10 分钟）

通过 CLI 让 Agent 调用该工具，验证：

- 工具可被正确识别
- 参数可被正确解析
- 返回结果对用户可读

---

## ✅ 本章检查清单

- [ ] 我能独立实现一个最小 Tool（含 schema 和 execute）
- [ ] 我能将 Tool 注册到运行流程并成功调用
- [ ] 我能处理至少 2 类错误场景
- [ ] 我完成了至少 1 次工具调用验证

---

**学习进度：** [███████████████░░░░░░] 15/21 章节  
**下一章：** [第 16 章：接入新的 Channel](./chapter16.md)
